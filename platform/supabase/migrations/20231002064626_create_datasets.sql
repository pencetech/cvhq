-- make sure you implement RLS policies

CREATE EXTENSION vector WITH SCHEMA PUBLIC;

CREATE TABLE "public"."dataset" (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dataset_uid UUID NOT NULL,
    user_id UUID NOT NULL REFERENCES profiles(id),
    name TEXT NOT NULL,
    checksum TEXT NOT NULL,

    CONSTRAINT unique_dataset_user_id UNIQUE (user_id),
    CONSTRAINT unique_dataset_dataset_uid UNIQUE (dataset_uid)
);

CREATE TABLE "public"."dataset_rows" (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dataset_uid UUID NOT NULL REFERENCES "public"."dataset"("dataset_uid"),
    content TEXT,
    embedding vector(1536)
);

ALTER TABLE "public"."dataset" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "public"."dataset_rows" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Every user has access to own dataset" ON "public"."dataset"
WITH CHECK ( auth.uid() = user_id );

CREATE POLICY "Every user has access to own dataset rows" ON "public"."dataset_rows"
WITH CHECK (
    auth.uid() in (
        SELECT user_id FROM dataset
        WHERE dataset.dataset_uid = dataset_rows.dataset_uid
    )
)